---
- name: Playbook to delete backups from Cisco Catalyst Center
  hosts: catalyst_center_hosts
  connection: local
  gather_facts: no

  vars_files:
    - "{{ VARS_FILE_PATH }}"
  
  vars:
    state: deleted
    catalyst_center_login: &catalyst_center_login
      dnac_host: "{{ catalyst_center_host | default(dnac_host) }}"
      dnac_username: "{{ catalyst_center_username | default(dnac_username) }}"
      dnac_password: "{{ catalyst_center_password | default(dnac_password) }}"
      dnac_version: "{{ catalyst_center_version | default(dnac_version) }}"
      dnac_port: "{{ catalyst_center_port | default(443) }}"
      dnac_verify: "{{ catalyst_center_verify | default(dnac_verify) }}"
      config_verify: "{{ catalyst_center_config_verify | default(config_verify) }}"
      dnac_debug: "{{ catalyst_center_debug | default(dnac_debug) }}"
      dnac_log: "{{ catalyst_center_log | default(dnac_log) }}"
      dnac_log_level: "{{ catalyst_center_log_level | default(dnac_log_level) }}"
      dnac_log_file_path: "{{ catalyst_center_log_file_path | default(omit) }}"
      dnac_log_append: "{{ catalyst_center_log_append | default(True) }}"
      dnac_api_task_timeout: "{{ catalyst_center_api_task_timeout | default(1200) }}"

  tasks:
    - name: Print VARS_FILE_PATH
      debug:
        msg: "Input file selected {{ VARS_FILE_PATH }}"
    
    - name: Playbook start time for delete backup operations
      set_fact:
        long_op_start: "{{ now() }}"
    
    # =========================================================================
    # Delete Backups from Cisco Catalyst Center
    # =========================================================================
    - name: Delete backups from Cisco Catalyst Center
      cisco.dnac.backup_and_restore_workflow_manager:
        <<: *catalyst_center_login
        state: "{{ state }}"
        config:
          - backup: "{{ item.backup }}"
      loop: "{{ backup_restore_details }}"
      when:
        - backup_restore_details is defined
        - item.backup is defined
      register: delete_backup_result

    - name: Display delete backup results
      ansible.builtin.debug:
        var: delete_backup_result
      when: delete_backup_result is defined

    # =========================================================================
    # Delete NFS Configuration
    # =========================================================================
    - name: Delete NFS configuration from Cisco Catalyst Center
      cisco.dnac.backup_and_restore_workflow_manager:
        <<: *catalyst_center_login
        state: "{{ state }}"
        config:
          - nfs_configuration: "{{ item.nfs_configuration }}"
      loop: "{{ backup_restore_details }}"
      when:
        - backup_restore_details is defined
        - item.nfs_configuration is defined
      register: delete_nfs_configuration_result

    - name: Display delete NFS configuration results
      ansible.builtin.debug:
        var: delete_nfs_configuration_result
      when: delete_nfs_configuration_result is defined

    # =========================================================================
    # Playbook Execution Summary
    # =========================================================================
    - name: Playbook end time
      set_fact:
        long_op_end: "{{ now() }}"
    
    - name: Print playbook execution time
      debug:
        msg: "Delete backup playbook run time: {{ long_op_start }}, end: {{ long_op_end }}"
  
  post_tasks:
    - name: Run command module to find python version
      command: which python
      register: ansible_play_path
      delegate_to: catalyst_center_hosts
      connection: local